<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Favoritos</title>
    <link rel="icon" type="image/x-icon" th:href="@{/img/logo/favicon.png}">
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/css/all-fontawesome.min.css}">
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>

<body>
    <div class="preloader">
        <div class="loader-ripple"><div></div><div></div></div>
    </div>

    <main class="main">
        <div class="site-breadcrumb" style="background: url(/img/breadcrumb/01.jpg)">
            <div class="container">
                <h2 class="breadcrumb-title">Mis Favoritos</h2>
                <ul class="breadcrumb-menu">
                    <li><a th:href="@{/}">Inicio</a></li>
                    <li><a th:href="@{/dashboard}">Dashboard</a></li>
                    <li class="active">Favoritos</li>
                </ul>
            </div>
        </div>

        <div class="user-profile py-120">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="user-profile-wrapper">
                            <div class="user-profile-card profile-favorite">
                                <h4 class="user-profile-card-title">Mis Favoritos</h4>
                                
                                <!-- Success/Error Messages -->
                                <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
                                    <span th:text="${success}"></span>
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                                <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                                    <span th:text="${error}"></span>
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                                
                                <div class="row">
                                    <!-- Empty State -->
                                    <div th:if="${favoriteCars == null or favoriteCars.isEmpty()}" class="col-12">
                                        <div class="text-center py-5">
                                            <i class="far fa-heart" style="font-size: 4rem; color: #ccc;"></i>
                                            <p class="text-muted mt-3">No tienes coches favoritos aún.</p>
                                            <a th:href="@{/cars}" class="theme-btn mt-3">
                                                <span class="far fa-search"></span> Explorar Inventario
                                            </a>
                                        </div>
                                    </div>
                                    
                                    <!-- Favorite Cars Grid -->
                                    <div th:each="car : ${favoriteCars}" class="col-md-6 col-lg-4">
                                        <div class="car-item">
                                            <div class="car-img">
                                                <span th:if="${car.condition != null}" 
                                                      class="car-status"
                                                      th:classappend="${car.condition.name() == 'NUEVO'} ? 'status-2' : 'status-1'"
                                                      th:text="${car.condition.name()}">Used</span>
                                                <img th:if="${car.images != null and !car.images.isEmpty()}" 
                                                     th:src="@{'/uploads/' + ${car.images[0]}}" 
                                                     alt="Car image">
                                                <img th:unless="${car.images != null and !car.images.isEmpty()}" 
                                                     th:src="@{/img/car/01.jpg}" 
                                                     alt="No image">
                                                <div class="car-btns">
                                                    <a href="#" 
                                                       class="remove-favorite" 
                                                       th:data-car-id="${car.id}"
                                                       title="Eliminar de favoritos">
                                                        <i class="far fa-trash-can"></i>
                                                    </a>
                                                    <a th:href="@{/cars/{id}(id=${car.id})}" title="Ver detalles">
                                                        <i class="far fa-eye"></i>
                                                    </a>
                                                </div>
                                            </div>
                                            <div class="car-content">
                                                <div class="car-top">
                                                    <h4>
                                                        <a th:href="@{/cars/{id}(id=${car.id})}" 
                                                           th:text="${car.make + ' ' + car.model}">Car Name</a>
                                                    </h4>
                                                </div>
                                                <ul class="car-list">
                                                    <li th:if="${car.transmission != null}">
                                                        <i class="far fa-steering-wheel"></i>
                                                        <span th:text="${car.transmission.name()}">Transmission</span>
                                                    </li>
                                                    <li th:if="${car.year != null}">
                                                        <i class="far fa-car"></i>
                                                        <span>Año: </span><span th:text="${car.year}">2023</span>
                                                    </li>
                                                    <li th:if="${car.mileage != null}">
                                                        <i class="far fa-road"></i>
                                                        <span th:text="${#numbers.formatInteger(car.mileage, 0, 'COMMA')} + ' km'">Mileage</span>
                                                    </li>
                                                    <li th:if="${car.fuelType != null}">
                                                        <i class="far fa-gas-pump"></i>
                                                        <span th:text="${car.fuelType.name()}">Fuel</span>
                                                    </li>
                                                </ul>
                                                <div class="car-footer">
                                                    <span class="car-price" th:text="${#numbers.formatDecimal(car.price, 0, 2)} + ' €'">Price</span>
                                                    <a th:href="@{/cars/{id}(id=${car.id})}" class="theme-btn">
                                                        <span class="far fa-eye"></span>Detalles
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script th:src="@{/js/jquery-3.6.0.min.js}"></script>
    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <script th:src="@{/js/main.js}"></script>
    <script>
        // Handle remove favorite
        $(document).on('click', '.remove-favorite', function(e) {
            e.preventDefault();
            
            if (!confirm('¿Estás seguro de que quieres eliminar este coche de favoritos?')) {
                return;
            }
            
            var carId = $(this).data('car-id');
            var $carItem = $(this).closest('.car-item').parent();
            
            $.ajax({
                url: '/favorites/remove/' + carId,
                type: 'POST',
                success: function(response) {
                    if (response.success) {
                        // Remove the car item from the grid
                        $carItem.fadeOut(300, function() {
                            $(this).remove();
                            
                            // Check if there are no more favorites
                            if ($('.car-item').length === 0) {
                                location.reload();
                            }
                        });
                    } else {
                        alert(response.message || 'Error al eliminar de favoritos');
                    }
                },
                error: function() {
                    alert('Error al eliminar de favoritos');
                }
            });
        });
    </script>
</body>
</html>