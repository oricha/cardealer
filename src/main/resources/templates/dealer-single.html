<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/header :: head(${dealer.name} + ' - Concesionario')}"></head>

<body>
    <nav th:replace="~{fragments/header :: navbar}"></nav>
    <div class="preloader">
        <div class="loader-ripple"><div></div><div></div></div>
    </div>

    <main class="main">
        <div class="site-breadcrumb" style="background: url(/img/breadcrumb/01.jpg)">
            <div class="container">
                <h2 class="breadcrumb-title" th:text="${dealer.name}">Dealer Name</h2>
                <ul class="breadcrumb-menu">
                    <li><a th:href="@{/}">Inicio</a></li>
                    <li><a th:href="@{/dealers}">Concesionarios</a></li>
                    <li class="active" th:text="${dealer.name}">Dealer</li>
                </ul>
            </div>
        </div>

        <div class="dealer-single bg py-120">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="dealer-banner">
                            <div class="dealer-banner-img">
                                <img th:if="${dealer.bannerUrl != null and !dealer.bannerUrl.isEmpty()}" 
                                     th:src="@{'/uploads/' + ${dealer.bannerUrl}}" 
                                     alt="Banner">
                                <img th:unless="${dealer.bannerUrl != null and !dealer.bannerUrl.isEmpty()}" 
                                     th:src="@{/img/store/banner.jpg}" 
                                     alt="Default banner">
                            </div>
                            <div class="dealer-banner-content">
                                <div class="dealer-banner-logo">
                                    <img th:if="${dealer.logoUrl != null and !dealer.logoUrl.isEmpty()}" 
                                         th:src="@{'/uploads/' + ${dealer.logoUrl}}" 
                                         alt="Logo">
                                    <img th:unless="${dealer.logoUrl != null and !dealer.logoUrl.isEmpty()}" 
                                         th:src="@{/img/store/logo.jpg}" 
                                         alt="Default logo">
                                </div>
                                <div class="dealer-banner-info">
                                    <h4 th:text="${dealer.name}">Dealer Name</h4>
                                    <span th:text="${totalListings} + ' Coches Listados'">0 Car Listed</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-9 mt-5">
                        <!-- Dealer Description -->
                        <div th:if="${dealer.description != null and !dealer.description.isEmpty()}" class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="far fa-info-circle"></i> Acerca de</h5>
                            </div>
                            <div class="card-body">
                                <p th:text="${dealer.description}">Description</p>
                            </div>
                        </div>
                        
                        <!-- Dealer Cars -->
                        <div class="col-md-12 mb-4">
                            <h5>Vehículos de este Concesionario</h5>
                        </div>
                        
                        <div th:if="${dealerCars == null or dealerCars.isEmpty()}" class="alert alert-info">
                            <i class="far fa-info-circle"></i> Este concesionario no tiene vehículos listados actualmente.
                        </div>
                        
                        <div class="row">
                            <div th:each="car : ${dealerCars}" class="col-md-6 col-lg-4">
                                <div class="car-item">
                                    <div class="car-img">
                                        <span th:if="${car.condition != null}" 
                                              class="car-status"
                                              th:classappend="${car.condition.name() == 'NUEVO'} ? 'status-2' : 'status-1'"
                                              th:text="${car.condition.name()}">Used</span>
                                        <img th:if="${car.images != null and !car.images.isEmpty()}" 
                                             th:src="@{'/uploads/' + ${car.images[0]}}" 
                                             alt="Car image">
                                        <img th:unless="${car.images != null and !car.images.isEmpty()}" 
                                             th:src="@{/img/car/01.jpg}" 
                                             alt="No image">
                                        <div class="car-btns">
                                            <a href="#" class="favorite-btn" th:data-car-id="${car.id}">
                                                <i class="far fa-heart"></i>
                                            </a>
                                        </div>
                                    </div>
                                    <div class="car-content">
                                        <div class="car-top">
                                            <h4>
                                                <a th:href="@{/cars/{id}(id=${car.id})}" 
                                                   th:text="${car.make + ' ' + car.model}">Car Name</a>
                                            </h4>
                                        </div>
                                        <ul class="car-list">
                                            <li th:if="${car.transmission != null}">
                                                <i class="far fa-steering-wheel"></i>
                                                <span th:text="${car.transmission.name()}">Transmission</span>
                                            </li>
                                            <li th:if="${car.mileage != null}">
                                                <i class="far fa-road"></i>
                                                <span th:text="${#numbers.formatInteger(car.mileage, 0, 'COMMA')} + ' km'">Mileage</span>
                                            </li>
                                            <li th:if="${car.year != null}">
                                                <i class="far fa-car"></i>
                                                <span>Año: </span><span th:text="${car.year}">2023</span>
                                            </li>
                                            <li th:if="${car.fuelType != null}">
                                                <i class="far fa-gas-pump"></i>
                                                <span th:text="${car.fuelType.name()}">Fuel</span>
                                            </li>
                                        </ul>
                                        <div class="car-footer">
                                            <span class="car-price" th:text="${#numbers.formatDecimal(car.price, 0, 2)} + ' €'">Price</span>
                                            <a th:href="@{/cars/{id}(id=${car.id})}" class="theme-btn">
                                                <span class="far fa-eye"></span>Detalles
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-3 mt-5">
                        <div class="car-single-widget">
                            <h5 class="mb-3">Información de Contacto</h5>
                            <div class="car-single-info">
                                <ul>
                                    <li th:if="${dealer.phone != null}">
                                        <i class="far fa-phone"></i>
                                        <a th:href="'tel:' + ${dealer.phone}" th:text="${dealer.phone}">Phone</a>
                                    </li>
                                    <li th:if="${dealer.email != null}">
                                        <i class="far fa-envelope"></i>
                                        <a th:href="'mailto:' + ${dealer.email}" th:text="${dealer.email}">Email</a>
                                    </li>
                                    <li th:if="${dealer.address != null}">
                                        <i class="far fa-location-dot"></i>
                                        <span th:text="${dealer.address}">Address</span>
                                    </li>
                                    <li th:if="${dealer.city != null}">
                                        <i class="far fa-map"></i>
                                        <span th:text="${dealer.city + (dealer.postalCode != null ? ' - ' + dealer.postalCode : '')}">City</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="car-single-widget mt-4">
                            <h5 class="mb-3">Contactar Concesionario</h5>
                            <div class="car-single-form">
                                <form th:action="@{/messages/send}" method="post">
                                    <input type="hidden" name="receiverId" th:value="${dealer.user.id}">
                                    
                                    <div class="form-group">
                                        <input type="text" class="form-control" name="subject" 
                                               placeholder="Asunto" required>
                                    </div>
                                    <div class="form-group">
                                        <textarea class="form-control" name="content" rows="3" 
                                                  placeholder="Escribe tu mensaje" required></textarea>
                                    </div>
                                    <div class="form-group">
                                        <button type="submit" class="theme-btn">
                                            Enviar Mensaje<i class="fas fa-arrow-right-long"></i>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer th:replace="~{fragments/footer :: footer}"></footer>

    <div th:replace="~{fragments/footer :: scroll-top}"></div>

    <div th:replace="~{fragments/header :: scripts}"></div>
    <script>
        // Handle favorite toggle
        $(document).on('click', '.favorite-btn', function(e) {
            e.preventDefault();
            var $btn = $(this);
            var carId = $btn.data('car-id');
            var isActive = $btn.hasClass('active');
            var url = isActive ? '/favorites/remove/' + carId : '/favorites/add/' + carId;
            
            $.ajax({
                url: url,
                type: 'POST',
                success: function(response) {
                    if (response.success) {
                        $btn.toggleClass('active');
                        $btn.find('i').toggleClass('far fas');
                    } else {
                        alert(response.message || 'Error al actualizar favoritos');
                    }
                },
                error: function() {
                    alert('Debes iniciar sesión para añadir favoritos');
                }
            });
        });
    </script>
</body>
</html>